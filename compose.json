{
  "version": "2.1",
  "networks": {
    "default": {
      "external": {
        "name": "ubuntu_default"
      }
    }
  },
  "services": {
    "consul": {
      "environment": [
        "SERVICE_8500_NAME=consul",
        "SERVICE=consul"
      ],
      "volumes": [
        "/data:/data",
        "/config:/config"
      ],
      "ports": [
        "${BLOCK_SSH_PORT}"
      ],
      "cap_add": [
        "NET_ADMIN"
      ],
      "networks": {
        "default": {
          "ipv4_address": "${NET_PREFIX}.1"
        }
      },
      "dns_search": "node.dc1.consul service.dc1.consul",
      "image": "${BLOCK_REGISTRY}/block:consul"
    },
    "openvpn": {
      "environment": [
        "SERVICE_1194_NAME=openvpn",
        "SERVICE=openvpn"
      ],
      "volumes": [
        "/data:/data",
        "/config:/config"
      ],
      "ports": [
        "${BLOCK_SSH_PORT}",
        "1194:1194"
      ],
      "privileged": true,
      "cap_add": [
        "NET_ADMIN"
      ],
      "cap_add": [
        "NET_ADMIN"
      ],
      "networks": {
        "default": {
          "ipv4_address": "${NET_PREFIX}.3"
        }
      },
      "dns_search": "node.dc1.consul service.dc1.consul",
      "image": "${BLOCK_REGISTRY}/block:openvpn"
    },
    "dnsmasq": {
      "environment": [
        "SERVICE_5353_NAME=dns",
        "SERVICE=dnsmasq"
      ],
      "volumes": [
        "/data:/data",
        "/config:/config"
      ],
      "ports": [
        "${BLOCK_SSH_PORT}",
        "5354:5353",
        "5354:5353/udp"
      ],
      "cap_add": [
        "NET_ADMIN"
      ],
      "dns_search": "node.dc1.consul service.dc1.consul",
      "image": "${BLOCK_REGISTRY}/block:dnsmasq"
    },
    "consul-ui": {
      "volumes": [
        "/data:/data",
        "/config:/config"
      ],
      "environment": [
        "SERVICE_8500_NAME=consul-ui",
        "SERVICE=consul-ui"
      ],
      "expose": [
        "8500"
      ],
      "ports": [
        "${BLOCK_SSH_PORT}"
      ],
      "cap_add": [
        "NET_ADMIN"
      ],
      "dns_search": "node.dc1.consul service.dc1.consul",
      "image": "${BLOCK_REGISTRY}/block:consul-ui"
    },
    "linkerd": {
      "volumes": [
        "/data:/data",
        "/config:/config"
      ],
      "environment": [
        "SERVICE_8888_NAME=linkerd-router",
        "SERVICE_9990_NAME=linkerd-admin",
        "SERVICE=linkerd"
      ],
      "expose": [
        "9990"
      ],
      "ports": [
        "${BLOCK_SSH_PORT}",
        "8888:8888"
      ],
      "cap_add": [
        "NET_ADMIN"
      ],
      "dns_search": "node.dc1.consul service.dc1.consul",
      "image": "${BLOCK_REGISTRY}/block:linkerd"
    },
    "linkerd-tcp": {
      "volumes": [
        "/data:/data",
        "/config:/config"
      ],
      "environment": [
        "SERVICE_3128_NAME=linkerd-tcp-squid",
        "SERVICE_9992_NAME=linkerd-tcp-admin",
        "SERVICE=linkerd-tcp"
      ],
      "ports": [
        "${BLOCK_SSH_PORT}",
        "3128:3128",
        "1080:3128",
        "80:8888",
        "9992:9992"
      ],
      "cap_add": [
        "NET_ADMIN"
      ],
      "dns_search": "node.dc1.consul service.dc1.consul",
      "image": "${BLOCK_REGISTRY}/block:linkerd-tcp"
    },
    "namerd": {
      "volumes": [
        "/data:/data",
        "/config:/config"
      ],
      "environment": [
        "SERVICE_4100_NAME=namerd-thrift",
        "SERVICE_4321_NAME=namerd-http",
        "SERVICE_9991_NAME=namerd-admin",
        "SERVICE=namerd"
      ],
      "ports": [
        "${BLOCK_SSH_PORT}",
        "4100:4100",
        "4321:4321",
        "9991:9991"
      ],
      "cap_add": [
        "NET_ADMIN"
      ],
      "dns_search": "node.dc1.consul service.dc1.consul",
      "image": "${BLOCK_REGISTRY}/block:namerd"
    },
    "etcd": {
      "environment": [
      ],
      "volumes": [
        "/data:/data",
        "/config:/config"
      ],
      "ports": [
        "${BLOCK_SSH_PORT}"
      ],
      "cap_add": [
        "NET_ADMIN"
      ],
      "dns_search": "node.dc1.consul service.dc1.consul",
      "image": "${BLOCK_REGISTRY}/block:etcd"
    },
    "registrator": {
      "volumes": [
        "/var/run/docker.sock:/tmp/docker.sock"
      ],
      "image": "gliderlabs/registrator",
      "command": "-internal -resync 120 -retry-attempts -1 consul://${NET_PREFIX}.1:8500"
    }
  }
}
